name: Claude Automation for GitHub

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository name or "all" for all repositories'
        required: true
        default: 'AIXTIV-SYMPHONY'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - align
          - clean
          - secure
          - memoria-assist
          - sync
      branch:
        description: 'Branch name'
        required: true
        default: 'main'
      organization:
        description: 'GitHub organization'
        required: true
        default: 'AI-Publishing-International-LLP-UK'
      security_check:
        description: 'Perform security checks'
        type: boolean
        default: true

  schedule:
    # Run weekly on Sunday at 2:00 AM
    - cron: '0 2 * * 0'

jobs:
  automate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Determine Parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "repository=all" >> $GITHUB_OUTPUT
            echo "action=clean" >> $GITHUB_OUTPUT
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "organization=AI-Publishing-International-LLP-UK" >> $GITHUB_OUTPUT
            echo "security_check=true" >> $GITHUB_OUTPUT
          else
            echo "repository=${{ github.event.inputs.repository }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
            echo "organization=${{ github.event.inputs.organization }}" >> $GITHUB_OUTPUT
            echo "security_check=${{ github.event.inputs.security_check }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Automation
        id: claude-automation
        run: |
          node bin/aixtiv.js claude:automation:github \
            --repository "${{ steps.params.outputs.repository }}" \
            --action "${{ steps.params.outputs.action }}" \
            --branch "${{ steps.params.outputs.branch }}" \
            --organization "${{ steps.params.outputs.organization }}" \
            --security-check "${{ steps.params.outputs.security_check }}"
          
          # Capture exit code
          RESULT=$?
          if [ $RESULT -ne 0 ]; then
            echo "::error::Claude automation failed with exit code $RESULT"
            exit $RESULT
          fi

      - name: Push Changes (if made)
        run: |
          # Check if there are any changes
          if [[ -n "$(git status --porcelain)" ]]; then
            # Commit and push changes
            git add .
            git commit -m "Claude automation: ${{ steps.params.outputs.action }} on ${{ steps.params.outputs.repository }}"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Open PR (if changes made to non-main branch)
        if: steps.params.outputs.branch != 'main' && steps.params.outputs.action != 'clean'
        uses: peter-evans/create-pull-request@v5
        with:
          title: "Claude automation: ${{ steps.params.outputs.action }} on ${{ steps.params.outputs.repository }}"
          body: |
            This PR was automatically created by the Claude Automation GitHub workflow.
            
            Action: ${{ steps.params.outputs.action }}
            Repository: ${{ steps.params.outputs.repository }}
            Organization: ${{ steps.params.outputs.organization }}
            Security checks: ${{ steps.params.outputs.security_check }}
            
            Please review the changes and merge if appropriate.
          branch: "claude-automation/${{ steps.params.outputs.action }}-${{ steps.params.outputs.repository }}"
          base: ${{ steps.params.outputs.branch }}
          delete-branch: true
          labels: "automated,claude"

      - name: Post Status to CI/CD Monitoring
        if: always()
        run: |
          # Send status to monitoring endpoint
          RESULT="${{ job.status }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Post to log
          echo "CI/CD Status for Claude Automation:"
          echo "Status: $RESULT"
          echo "Time: $TIMESTAMP"
          echo "Action: ${{ steps.params.outputs.action }}"
          echo "Repository: ${{ steps.params.outputs.repository }}"

