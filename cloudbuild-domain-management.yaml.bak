steps:
  # Initialize with Authentication and Project Setup
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'initialize'
    args:
      - 'config'
      - 'set'
      - 'project'
      - 'api-for-warp-drive'

  # Install Dependencies
  - name: 'gcr.io/cloud-builders/npm'
    id: 'install'
    args: ['install']

  # Linting
  - name: 'gcr.io/cloud-builders/npm'
    id: 'lint'
    args: ['run', 'lint']

  # Build Application
  - name: 'gcr.io/cloud-builders/npm'
    id: 'build'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Starting application build..."
        npm run build
        echo "Build completed successfully"

  # Validate Domain Management Command
  - name: 'gcr.io/cloud-builders/npm'
    id: 'validate-domain-management'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Validating domain management command..."
        # Check if the command file exists
        if [ -f "commands/domain/manage.js" ]; then
          echo "‚úÖ Domain management command file exists"
        else
          echo "‚ùå Domain management command file not found"
          exit 1
        fi

        # Check command registration
        if grep -q "domainManageCommand" "commands/domain/index.js"; then
          echo "‚úÖ Domain management command is registered"
        else
          echo "‚ùå Domain management command registration not found"
          exit 1
        fi

        # Run the help command to verify it's working
        node bin/aixtiv.js domain:manage --help

        echo "Domain management command validation successful"

  # Docker Image Build
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-build'
    args: ['build', '-t', 'gcr.io/api-for-warp-drive/aixtiv-cli:domain-management-$COMMIT_SHA', '.']

  # Push Docker Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'docker-push'
    args: ['push', 'gcr.io/api-for-warp-drive/aixtiv-cli:domain-management-$COMMIT_SHA']

  # Deploy to Staging Environment (Update)
  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'deploy-staging'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Connect to GKE cluster
        gcloud container clusters get-credentials private-cluster-auto --zone us-west1-b --project api-for-warp-drive

        echo "Starting deployment to staging environment..."

        # Update deployment YAML with new image
        sed -i "s|gcr.io/api-for-warp-drive/aixtiv-cli:.*|gcr.io/api-for-warp-drive/aixtiv-cli:domain-management-$COMMIT_SHA|g" infrastructure/staging/deployment.yaml

        # Apply updated deployment
        kubectl apply -f infrastructure/staging/deployment.yaml
        kubectl apply -f infrastructure/staging/service.yaml

        echo "Deployment to staging completed"
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=us-west1-b'
      - 'CLOUDSDK_CONTAINER_CLUSTER=private-cluster-auto'

  # Notify Deployment Completion
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'notify-completion'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ Domain Management Deployment Pipeline completed successfully!"
        echo "‚úÖ Domain Management Command: DEPLOYED"
        echo "‚úÖ Staging deployment: COMPLETE"
        echo "‚úÖ Docker Image: gcr.io/api-for-warp-drive/aixtiv-cli:domain-management-$COMMIT_SHA"

        # Record deployment in Firestore
        gcloud firestore documents create projects/api-for-warp-drive/databases/(default)/documents/deployments/$(date +%Y%m%d%H%M%S) \
          --fields="status=SUCCESS,timestamp=$(date +%s),feature=domain-management,version=$COMMIT_SHA,environment=staging"

timeout: 1800s # 30 minutes
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

artifacts:
  objects:
    location: 'gs://api-for-warp-drive-artifacts/builds/$BUILD_ID/'
    paths: ['dist/**/*']

serviceAccount: 'projects/api-for-warp-drive/serviceAccounts/drlucyautomation@api-for-warp-drive.iam.gserviceaccount.com'
